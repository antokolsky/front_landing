name: Build and deploy
on: [push]
env:
    LANDING_IMAGE: ${{ secrets.DOCKER_LOGIN}}/antokolsky_landing:latest
jobs:
    build:
        name: build and deploy
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/build_and_deploy'
        steps:
            - name: checkout
              uses: actions/checkout@v3
            - name: build
              uses: docker/setup-buildx-action@v2
            - name: login to DockerHub
              uses: docker/login-action@v2
              with:
                username: ${{ secrets.DOCKER_LOGIN }}
                password: ${{ secrets.DOCKER_PASSWORD }}
            - name: push
              uses: docker/build-push-action@v4
              with:
                push: true
                file: Dockerfile
                tags: ${{ env.LANDING_IMAGE }}
    
    # deploy:
    #     runs-on: ubuntu-latest
    #     needs: build
    #     steps:
    #         - name: checkout
    #           uses: actions/checkout@v3
    #         - name: copy docker-compose.yaml
    #           uses: appleboy/scp-action@master
    #           with: 
    #             host: ${{ secrets.HOST }}
    #             username: ${{ secrets.HOST_USERNAME }}
    #             key: ${{ secrets.SSK_KEY }}
    #             passphrase: ${{ secrets.SSH_PHRASE }}
    #             source: "docker-compose.yaml"
    #             target: "antokolsky"
    #             debug: true
    #         - name: ssh to remote server
    #           uses: appleboy/ssh-action@master
    #           with:
    #             host: ${{ secrets.HOST }}
    #             username: ${{ secrets.HOST_USERNAME }}
    #             key: ${{ secrets.SSK_KEY }}
    #             passphrase: ${{ secrets.SSH_PHRASE }}
    #             script: |
    #               cd ~/antokolsky
    #               sudo docker compose stop
    #               sudo docker compose pull ${{ env.LANDING_IMAGE }}
    #               sudo docker compose up -d
    #               sudo docker image prune -f